<div class="guess-container">
  <h2 class="guess-title">Guess This Player's Stats</h2>

  <!-- Username Input Section -->
  @if (!hasUsername()) {
    <div class="username-section">
      <h3 class="username-title">Enter Your Username</h3>
      <div class="username-input-container">
        <input
          type="text"
          class="username-input"
          [ngModel]="username()"
          (ngModelChange)="username.set($event)"
          (keydown.enter)="onUsernameSubmit()"
          placeholder="Enter your username..."
          autocomplete="off"
        />
        <button
          class="username-submit-button"
          (click)="onUsernameSubmit()"
          [disabled]="!username().trim()"
        >
          Submit
        </button>
      </div>
      @if (error() && !player()) {
        <p class="error-message">{{ error() }}</p>
      }
    </div>
  } @else {
    <div class="username-welcome">
      <h3 class="username-welcome-text">Time to Guess your Player, {{ username() }}!</h3>
    </div>
  }

  <!-- Filters Section -->
  <div class="filters-section">
    <button class="filters-toggle-button" (click)="toggleFilters()">
      {{ showFilters() ? 'Hide' : 'Show' }} Filters
    </button>
    
    @if (showFilters()) {
      <div class="filters-panel">
        <div class="filters-header">
          <h3 class="filters-title">Filter Players</h3>
          <button class="clear-filters-button" (click)="clearFilters()">Clear All</button>
        </div>
        
        <div class="filters-grid">
          <!-- PPG Filter -->
          <div class="filter-group">
            <label class="filter-label">Points Per Game (PPG)</label>
            <div class="filter-range">
              <input
                type="number"
                step="0.1"
                min="0"
                [(ngModel)]="filterPpgMin"
                placeholder="Min"
                class="filter-input"
              />
              <span class="filter-separator">-</span>
              <input
                type="number"
                step="0.1"
                min="0"
                [(ngModel)]="filterPpgMax"
                placeholder="Max"
                class="filter-input"
              />
            </div>
          </div>

          <!-- APG Filter -->
          <div class="filter-group">
            <label class="filter-label">Assists Per Game (APG)</label>
            <div class="filter-range">
              <input
                type="number"
                step="0.1"
                min="0"
                [(ngModel)]="filterApgMin"
                placeholder="Min"
                class="filter-input"
              />
              <span class="filter-separator">-</span>
              <input
                type="number"
                step="0.1"
                min="0"
                [(ngModel)]="filterApgMax"
                placeholder="Max"
                class="filter-input"
              />
            </div>
          </div>

          <!-- RPG Filter -->
          <div class="filter-group">
            <label class="filter-label">Rebounds Per Game (RPG)</label>
            <div class="filter-range">
              <input
                type="number"
                step="0.1"
                min="0"
                [(ngModel)]="filterRpgMin"
                placeholder="Min"
                class="filter-input"
              />
              <span class="filter-separator">-</span>
              <input
                type="number"
                step="0.1"
                min="0"
                [(ngModel)]="filterRpgMax"
                placeholder="Max"
                class="filter-input"
              />
            </div>
          </div>

          <!-- Age Filter -->
          <div class="filter-group">
            <label class="filter-label">Age</label>
            <div class="filter-range">
              <input
                type="number"
                step="1"
                min="18"
                max="50"
                [(ngModel)]="filterAgeMin"
                placeholder="Min"
                class="filter-input"
              />
              <span class="filter-separator">-</span>
              <input
                type="number"
                step="1"
                min="18"
                max="50"
                [(ngModel)]="filterAgeMax"
                placeholder="Max"
                class="filter-input"
              />
            </div>
          </div>

          <!-- Team Filter -->
          <div class="filter-group filter-group-full">
            <label class="filter-label">Team (Abbreviation)</label>
            <input
              type="text"
              [(ngModel)]="filterTeam"
              placeholder="e.g., LAL, GSW, BOS"
              class="filter-input filter-input-full"
              maxlength="3"
            />
          </div>
        </div>
        
        <div class="filters-footer">
          <button class="apply-filters-button" (click)="loadRandomPlayer()">
            Apply Filters & Get New Player
          </button>
        </div>
      </div>
    }
  </div>

  @if (isLoading()) {
    <div class="loading-state">
      <p>Loading player...</p>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <p>{{ error() }}</p>
      <button class="retry-button" (click)="loadRandomPlayer()">Retry</button>
    </div>
  } @else if (player()) {
    <!-- Player Image -->
    <div class="player-image-container">
      <img
        class="player-image"
        [src]="getHeadshotSrc(player())"
        [alt]="player()!.full_name + ' headshot'"
        (error)="onHeadshotError(player(), $event)"
      />
    </div>

    <!-- Player Name -->
    <h3 class="player-name">{{ player()!.full_name }}</h3>

    <!-- Input Form -->
    <div class="guess-form">
      <div class="input-row">
        <div class="input-group">
          <label for="ppg">PPG</label>
          <input
            id="ppg"
            type="number"
            step="0.1"
            min="0"
            [(ngModel)]="ppg"
            placeholder="Points Per Game"
            class="stat-input"
          />
        </div>
        <div class="input-group">
          <label for="rpg">RBG</label>
          <input
            id="rpg"
            type="number"
            step="0.1"
            min="0"
            [(ngModel)]="rpg"
            placeholder="Rebounds Per Game"
            class="stat-input"
          />
        </div>
        <div class="input-group">
          <label for="apg">APG</label>
          <input
            id="apg"
            type="number"
            step="0.1"
            min="0"
            [(ngModel)]="apg"
            placeholder="Assists Per Game"
            class="stat-input"
          />
        </div>
        <div class="input-group">
          <label for="spg">SPG</label>
          <input
            id="spg"
            type="number"
            step="0.1"
            min="0"
            [(ngModel)]="spg"
            placeholder="Steals Per Game"
            class="stat-input"
          />
        </div>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label for="bpg">BPG</label>
          <input
            id="bpg"
            type="number"
            step="0.1"
            min="0"
            [(ngModel)]="bpg"
            placeholder="Blocks Per Game"
            class="stat-input"
          />
        </div>
        <div class="input-group">
          <label for="fg">FG%</label>
          <input
            id="fg"
            type="number"
            step="0.1"
            min="0"
            max="100"
            [(ngModel)]="fg"
            placeholder="Field Goal %"
            class="stat-input"
          />
        </div>
        <div class="input-group">
          <label for="threeP">3P%</label>
          <input
            id="threeP"
            type="number"
            step="0.1"
            min="0"
            max="100"
            [(ngModel)]="threeP"
            placeholder="Three Point %"
            class="stat-input"
          />
        </div>
        <div class="input-group">
          <label for="ft">FT%</label>
          <input
            id="ft"
            type="number"
            step="0.1"
            min="0"
            max="100"
            [(ngModel)]="ft"
            placeholder="Free Throw %"
            class="stat-input"
          />
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="submit-button" (click)="onSubmit()">Submit</button>
      <button class="new-player-button" (click)="loadRandomPlayer()">New Player</button>
    </div>

    <!-- Result Modal -->
    @if (showResult() && score() !== null) {
      <div class="modal-background" (click)="closeModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <h2 class="modal-header">You scored {{ score()!.toFixed(1) }}% on {{ player()!.full_name }}!</h2>
          
          <!-- Desktop view - pre-formatted text -->
          <pre class="modal-text desktop-comparison">{{ comparisonText() }}</pre>
          
          <!-- Mobile view - structured layout -->
          <div class="mobile-comparison">
            <h3 class="comparison-title">Stats Comparison for {{ player()!.full_name }}:</h3>
            <div class="comparison-stats">
              @for (stat of comparisonStats(); track stat.label) {
                <div class="stat-comparison-row">
                  <span class="stat-label">{{ stat.label }}:</span>
                  <div class="stat-values">
                    <span class="stat-value">
                      <span class="value-label">Your Guess:</span>
                      <span class="value-number">{{ stat.guess }}</span>
                    </span>
                    <span class="stat-value">
                      <span class="value-label">Actual:</span>
                      <span class="value-number">{{ stat.actual }}</span>
                    </span>
                  </div>
                </div>
              }
            </div>
          </div>
          
          <button class="modal-close-button" (click)="closeModal()">Close</button>
        </div>
      </div>
    }

    <!-- Leaderboard Section -->
    @if (player() && player()!.player_id) {
      <div class="leaderboard-section">
        <h3 class="leaderboard-title">Leaderboard for {{ player()!.full_name }}</h3>
        @if (isLoadingLeaderboard()) {
          <p class="leaderboard-loading">Loading leaderboard...</p>
        } @else if (leaderboard().length === 0) {
          <p class="leaderboard-empty">No scores yet. Be the first to submit a guess!</p>
        } @else {
          <div class="leaderboard-table-container">
            <table class="leaderboard-table">
              <thead>
                <tr>
                  <th class="leaderboard-header">Username</th>
                  <th class="leaderboard-header">Score</th>
                  <th class="leaderboard-header">Date</th>
                </tr>
              </thead>
              <tbody>
                @for (entry of leaderboard(); track entry.id) {
                  <tr class="leaderboard-row">
                    <td class="leaderboard-cell leaderboard-username">{{ entry.userName }}</td>
                    <td class="leaderboard-cell leaderboard-score">{{ entry.score }}</td>
                    <td class="leaderboard-cell leaderboard-date">{{ entry.gameDate }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    }
  }
</div>

